name: Build Android App

# Trigger the build on push to the main branch
on:
  push:
    branches:
      - main

# Define the jobs that should run
jobs:
  build:
    runs-on: ubuntu-latest  # Using the latest Ubuntu image for the CI environment

    steps:
      # Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Set up JDK 11 for Gradle
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'

      # Set up Android SDK and related tools
      - name: Set up Android SDK
        uses: react-native-community/android-sdk@v2
        with:
          android-version: '30'  # Adjust to the required Android version for your app

      # Install the required dependencies such as qemu, sdkmanager, and aapt2
      - name: Install dependencies
        run: |
          # Update and install dependencies
          sudo apt-get update
          sudo apt-get install -y qemu qemu-user qemu-user-static
          
          # Install Android build tools
          sdkmanager "build-tools;30.0.3"  # Ensure the correct version of build-tools is installed
          sdkmanager "platform-tools"
          sdkmanager "platforms;android-30"  # Adjust to your target Android API level
          sdkmanager --update

          # Ensure the aapt2 executable is available
          echo "android.aapt2FromMavenOverride=$(which aapt2)" >> $GITHUB_ENV

      # Build the app using Gradle
      - name: Build the project
        run: |
          ./gradlew clean  # Clean the previous builds
          ./gradlew :app:assembleDebug --no-daemon --stacktrace  # Assemble the app with debugging info

      # Optionally, you can add steps for running tests or deploying the app
      - name: Run unit tests
        run: |
          ./gradlew testDebugUnitTest --no-daemon --stacktrace

      # You can also add steps to deploy the app or upload build artifacts
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v2
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
